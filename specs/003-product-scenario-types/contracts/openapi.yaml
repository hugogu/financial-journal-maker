openapi: 3.0.3
info:
  title: Product/Scenario/TransactionType API
  description: API for managing business domain concepts - Products, Scenarios, and Transaction Types
  version: 1.0.0
  
servers:
  - url: http://localhost:8080/api/v1
    description: Local development server

tags:
  - name: Products
    description: Product management operations
  - name: Scenarios
    description: Scenario management operations
  - name: TransactionTypes
    description: Transaction type management operations

paths:
  # ==================== PRODUCTS ====================
  /products:
    get:
      tags: [Products]
      summary: List all products
      operationId: listProducts
      parameters:
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/EntityStatus'
        - name: search
          in: query
          schema:
            type: string
          description: Search by code or name
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/SizeParam'
      responses:
        '200':
          description: Paginated list of products
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductPage'
    post:
      tags: [Products]
      summary: Create a new product
      operationId: createProduct
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductCreateRequest'
      responses:
        '201':
          description: Product created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductResponse'
          headers:
            Location:
              schema:
                type: string
              description: URL of created product
        '400':
          $ref: '#/components/responses/ValidationError'
        '409':
          $ref: '#/components/responses/ConflictError'

  /products/{id}:
    get:
      tags: [Products]
      summary: Get product by ID
      operationId: getProduct
      parameters:
        - $ref: '#/components/parameters/ProductId'
      responses:
        '200':
          description: Product details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
    put:
      tags: [Products]
      summary: Update product
      operationId: updateProduct
      parameters:
        - $ref: '#/components/parameters/ProductId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductUpdateRequest'
      responses:
        '200':
          description: Product updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '409':
          $ref: '#/components/responses/ConflictError'
    delete:
      tags: [Products]
      summary: Delete product
      operationId: deleteProduct
      parameters:
        - $ref: '#/components/parameters/ProductId'
      responses:
        '204':
          description: Product deleted
        '404':
          $ref: '#/components/responses/NotFoundError'
        '409':
          description: Product has child scenarios
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /products/code/{code}:
    get:
      tags: [Products]
      summary: Get product by code
      operationId: getProductByCode
      parameters:
        - name: code
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Product details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /products/{id}/activate:
    post:
      tags: [Products]
      summary: Activate product
      operationId: activateProduct
      parameters:
        - $ref: '#/components/parameters/ProductId'
      responses:
        '200':
          description: Product activated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductResponse'

  /products/{id}/archive:
    post:
      tags: [Products]
      summary: Archive product
      operationId: archiveProduct
      parameters:
        - $ref: '#/components/parameters/ProductId'
      responses:
        '200':
          description: Product archived
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductResponse'

  /products/{id}/restore:
    post:
      tags: [Products]
      summary: Restore archived product to draft
      operationId: restoreProduct
      parameters:
        - $ref: '#/components/parameters/ProductId'
      responses:
        '200':
          description: Product restored
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductResponse'

  /products/{id}/tree:
    get:
      tags: [Products]
      summary: Get product hierarchy tree
      operationId: getProductTree
      parameters:
        - $ref: '#/components/parameters/ProductId'
      responses:
        '200':
          description: Hierarchical tree of product with scenarios and types
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductTreeResponse'

  /products/{id}/clone:
    post:
      tags: [Products]
      summary: Clone product with all scenarios and types
      operationId: cloneProduct
      parameters:
        - $ref: '#/components/parameters/ProductId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CloneRequest'
      responses:
        '201':
          description: Product cloned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductResponse'

  /products/{id}/rules:
    get:
      tags: [Products]
      summary: Get all rules associated with product (via types)
      operationId: getProductRules
      parameters:
        - $ref: '#/components/parameters/ProductId'
      responses:
        '200':
          description: List of associated rules
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/RuleSummary'

  /products/{id}/accounts:
    get:
      tags: [Products]
      summary: Get all accounts used in product's rules
      operationId: getProductAccounts
      parameters:
        - $ref: '#/components/parameters/ProductId'
      responses:
        '200':
          description: List of accounts used
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AccountSummary'

  # ==================== SCENARIOS ====================
  /scenarios:
    get:
      tags: [Scenarios]
      summary: List scenarios
      operationId: listScenarios
      parameters:
        - name: productId
          in: query
          schema:
            type: integer
            format: int64
          description: Filter by product
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/EntityStatus'
        - name: search
          in: query
          schema:
            type: string
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/SizeParam'
      responses:
        '200':
          description: Paginated list of scenarios
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScenarioPage'
    post:
      tags: [Scenarios]
      summary: Create a new scenario
      operationId: createScenario
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScenarioCreateRequest'
      responses:
        '201':
          description: Scenario created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScenarioResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '409':
          $ref: '#/components/responses/ConflictError'

  /scenarios/{id}:
    get:
      tags: [Scenarios]
      summary: Get scenario by ID
      operationId: getScenario
      parameters:
        - $ref: '#/components/parameters/ScenarioId'
      responses:
        '200':
          description: Scenario details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScenarioResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
    put:
      tags: [Scenarios]
      summary: Update scenario
      operationId: updateScenario
      parameters:
        - $ref: '#/components/parameters/ScenarioId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScenarioUpdateRequest'
      responses:
        '200':
          description: Scenario updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScenarioResponse'
    delete:
      tags: [Scenarios]
      summary: Delete scenario
      operationId: deleteScenario
      parameters:
        - $ref: '#/components/parameters/ScenarioId'
      responses:
        '204':
          description: Scenario deleted
        '409':
          description: Scenario has child transaction types

  /scenarios/{id}/activate:
    post:
      tags: [Scenarios]
      summary: Activate scenario
      operationId: activateScenario
      parameters:
        - $ref: '#/components/parameters/ScenarioId'
      responses:
        '200':
          description: Scenario activated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScenarioResponse'

  /scenarios/{id}/archive:
    post:
      tags: [Scenarios]
      summary: Archive scenario
      operationId: archiveScenario
      parameters:
        - $ref: '#/components/parameters/ScenarioId'
      responses:
        '200':
          description: Scenario archived
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScenarioResponse'

  /scenarios/{id}/restore:
    post:
      tags: [Scenarios]
      summary: Restore archived scenario
      operationId: restoreScenario
      parameters:
        - $ref: '#/components/parameters/ScenarioId'
      responses:
        '200':
          description: Scenario restored
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScenarioResponse'

  /scenarios/{id}/clone:
    post:
      tags: [Scenarios]
      summary: Clone scenario with all transaction types
      operationId: cloneScenario
      parameters:
        - $ref: '#/components/parameters/ScenarioId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScenarioCloneRequest'
      responses:
        '201':
          description: Scenario cloned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScenarioResponse'

  /scenarios/{id}/rules:
    get:
      tags: [Scenarios]
      summary: Get all rules associated with scenario
      operationId: getScenarioRules
      parameters:
        - $ref: '#/components/parameters/ScenarioId'
      responses:
        '200':
          description: List of associated rules
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/RuleSummary'

  /scenarios/{id}/accounts:
    get:
      tags: [Scenarios]
      summary: Get all accounts used in scenario's rules
      operationId: getScenarioAccounts
      parameters:
        - $ref: '#/components/parameters/ScenarioId'
      responses:
        '200':
          description: List of accounts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AccountSummary'

  # ==================== TRANSACTION TYPES ====================
  /transaction-types:
    get:
      tags: [TransactionTypes]
      summary: List transaction types
      operationId: listTransactionTypes
      parameters:
        - name: scenarioId
          in: query
          schema:
            type: integer
            format: int64
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/EntityStatus'
        - name: search
          in: query
          schema:
            type: string
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/SizeParam'
      responses:
        '200':
          description: Paginated list of transaction types
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionTypePage'
    post:
      tags: [TransactionTypes]
      summary: Create a new transaction type
      operationId: createTransactionType
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TransactionTypeCreateRequest'
      responses:
        '201':
          description: Transaction type created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionTypeResponse'

  /transaction-types/{id}:
    get:
      tags: [TransactionTypes]
      summary: Get transaction type by ID
      operationId: getTransactionType
      parameters:
        - $ref: '#/components/parameters/TransactionTypeId'
      responses:
        '200':
          description: Transaction type details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionTypeResponse'
    put:
      tags: [TransactionTypes]
      summary: Update transaction type
      operationId: updateTransactionType
      parameters:
        - $ref: '#/components/parameters/TransactionTypeId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TransactionTypeUpdateRequest'
      responses:
        '200':
          description: Transaction type updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionTypeResponse'
    delete:
      tags: [TransactionTypes]
      summary: Delete transaction type
      operationId: deleteTransactionType
      parameters:
        - $ref: '#/components/parameters/TransactionTypeId'
      responses:
        '204':
          description: Transaction type deleted (rule associations removed)

  /transaction-types/{id}/activate:
    post:
      tags: [TransactionTypes]
      summary: Activate transaction type
      operationId: activateTransactionType
      parameters:
        - $ref: '#/components/parameters/TransactionTypeId'
      responses:
        '200':
          description: Transaction type activated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionTypeResponse'

  /transaction-types/{id}/archive:
    post:
      tags: [TransactionTypes]
      summary: Archive transaction type
      operationId: archiveTransactionType
      parameters:
        - $ref: '#/components/parameters/TransactionTypeId'
      responses:
        '200':
          description: Transaction type archived
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionTypeResponse'

  /transaction-types/{id}/restore:
    post:
      tags: [TransactionTypes]
      summary: Restore archived transaction type
      operationId: restoreTransactionType
      parameters:
        - $ref: '#/components/parameters/TransactionTypeId'
      responses:
        '200':
          description: Transaction type restored
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionTypeResponse'

  /transaction-types/{id}/rules:
    get:
      tags: [TransactionTypes]
      summary: Get rules associated with transaction type
      operationId: getTransactionTypeRules
      parameters:
        - $ref: '#/components/parameters/TransactionTypeId'
      responses:
        '200':
          description: List of associated rules
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/RuleAssociation'
    post:
      tags: [TransactionTypes]
      summary: Associate rule with transaction type
      operationId: addRuleToTransactionType
      parameters:
        - $ref: '#/components/parameters/TransactionTypeId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RuleAssociationRequest'
      responses:
        '201':
          description: Rule associated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RuleAssociation'
        '400':
          description: Rule is ARCHIVED and cannot be associated

  /transaction-types/{id}/rules/{ruleId}:
    delete:
      tags: [TransactionTypes]
      summary: Remove rule association
      operationId: removeRuleFromTransactionType
      parameters:
        - $ref: '#/components/parameters/TransactionTypeId'
        - name: ruleId
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '204':
          description: Association removed

components:
  parameters:
    ProductId:
      name: id
      in: path
      required: true
      schema:
        type: integer
        format: int64
    ScenarioId:
      name: id
      in: path
      required: true
      schema:
        type: integer
        format: int64
    TransactionTypeId:
      name: id
      in: path
      required: true
      schema:
        type: integer
        format: int64
    PageParam:
      name: page
      in: query
      schema:
        type: integer
        default: 0
    SizeParam:
      name: size
      in: query
      schema:
        type: integer
        default: 20

  schemas:
    EntityStatus:
      type: string
      enum: [DRAFT, ACTIVE, ARCHIVED]

    # ===== Product Schemas =====
    ProductCreateRequest:
      type: object
      required: [code, name]
      properties:
        code:
          type: string
          maxLength: 50
        name:
          type: string
          maxLength: 200
        description:
          type: string
        businessModel:
          type: string
        participants:
          type: string
        fundFlow:
          type: string

    ProductUpdateRequest:
      type: object
      required: [version]
      properties:
        name:
          type: string
          maxLength: 200
        description:
          type: string
        businessModel:
          type: string
        participants:
          type: string
        fundFlow:
          type: string
        version:
          type: integer
          format: int64

    ProductResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
        code:
          type: string
        name:
          type: string
        description:
          type: string
        businessModel:
          type: string
        participants:
          type: string
        fundFlow:
          type: string
        status:
          $ref: '#/components/schemas/EntityStatus'
        scenarioCount:
          type: integer
        version:
          type: integer
          format: int64
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    ProductPage:
      type: object
      properties:
        content:
          type: array
          items:
            $ref: '#/components/schemas/ProductResponse'
        totalElements:
          type: integer
          format: int64
        totalPages:
          type: integer
        size:
          type: integer
        number:
          type: integer

    ProductTreeResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
        code:
          type: string
        name:
          type: string
        status:
          $ref: '#/components/schemas/EntityStatus'
        scenarios:
          type: array
          items:
            $ref: '#/components/schemas/ScenarioTreeNode'

    ScenarioTreeNode:
      type: object
      properties:
        id:
          type: integer
          format: int64
        code:
          type: string
        name:
          type: string
        status:
          $ref: '#/components/schemas/EntityStatus'
        transactionTypes:
          type: array
          items:
            $ref: '#/components/schemas/TransactionTypeTreeNode'

    TransactionTypeTreeNode:
      type: object
      properties:
        id:
          type: integer
          format: int64
        code:
          type: string
        name:
          type: string
        status:
          $ref: '#/components/schemas/EntityStatus'
        ruleCount:
          type: integer

    # ===== Scenario Schemas =====
    ScenarioCreateRequest:
      type: object
      required: [productId, code, name]
      properties:
        productId:
          type: integer
          format: int64
        code:
          type: string
          maxLength: 50
        name:
          type: string
          maxLength: 200
        description:
          type: string
        triggerDescription:
          type: string
        fundFlowPath:
          type: string

    ScenarioUpdateRequest:
      type: object
      required: [version]
      properties:
        name:
          type: string
        description:
          type: string
        triggerDescription:
          type: string
        fundFlowPath:
          type: string
        version:
          type: integer
          format: int64

    ScenarioResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
        productId:
          type: integer
          format: int64
        productCode:
          type: string
        code:
          type: string
        name:
          type: string
        description:
          type: string
        triggerDescription:
          type: string
        fundFlowPath:
          type: string
        status:
          $ref: '#/components/schemas/EntityStatus'
        transactionTypeCount:
          type: integer
        version:
          type: integer
          format: int64
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    ScenarioPage:
      type: object
      properties:
        content:
          type: array
          items:
            $ref: '#/components/schemas/ScenarioResponse'
        totalElements:
          type: integer
          format: int64
        totalPages:
          type: integer
        size:
          type: integer
        number:
          type: integer

    ScenarioCloneRequest:
      type: object
      required: [newCode]
      properties:
        newCode:
          type: string
          maxLength: 50
        newName:
          type: string
        targetProductId:
          type: integer
          format: int64
          description: If not provided, clones to same product

    # ===== Transaction Type Schemas =====
    TransactionTypeCreateRequest:
      type: object
      required: [scenarioId, code, name]
      properties:
        scenarioId:
          type: integer
          format: int64
        code:
          type: string
          maxLength: 50
        name:
          type: string
          maxLength: 200
        description:
          type: string

    TransactionTypeUpdateRequest:
      type: object
      required: [version]
      properties:
        name:
          type: string
        description:
          type: string
        version:
          type: integer
          format: int64

    TransactionTypeResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
        scenarioId:
          type: integer
          format: int64
        scenarioCode:
          type: string
        code:
          type: string
        name:
          type: string
        description:
          type: string
        status:
          $ref: '#/components/schemas/EntityStatus'
        ruleCount:
          type: integer
        version:
          type: integer
          format: int64
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    TransactionTypePage:
      type: object
      properties:
        content:
          type: array
          items:
            $ref: '#/components/schemas/TransactionTypeResponse'
        totalElements:
          type: integer
          format: int64
        totalPages:
          type: integer
        size:
          type: integer
        number:
          type: integer

    # ===== Rule Association Schemas =====
    RuleAssociationRequest:
      type: object
      required: [ruleId]
      properties:
        ruleId:
          type: integer
          format: int64
        sequenceNumber:
          type: integer
          default: 0

    RuleAssociation:
      type: object
      properties:
        id:
          type: integer
          format: int64
        ruleId:
          type: integer
          format: int64
        ruleCode:
          type: string
        ruleName:
          type: string
        ruleStatus:
          type: string
        sequenceNumber:
          type: integer
        createdAt:
          type: string
          format: date-time

    RuleSummary:
      type: object
      properties:
        id:
          type: integer
          format: int64
        code:
          type: string
        name:
          type: string
        status:
          type: string

    AccountSummary:
      type: object
      properties:
        code:
          type: string
        name:
          type: string
        usageCount:
          type: integer
          description: Number of rules using this account

    # ===== Common Schemas =====
    CloneRequest:
      type: object
      required: [newCode]
      properties:
        newCode:
          type: string
          maxLength: 50
        newName:
          type: string

    ErrorResponse:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        status:
          type: integer
        error:
          type: string
        message:
          type: string
        path:
          type: string

  responses:
    ValidationError:
      description: Validation error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFoundError:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    ConflictError:
      description: Conflict (duplicate or version mismatch)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
