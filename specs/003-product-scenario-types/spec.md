# Feature Specification: Product/Scenario/TransactionType Management

**Feature Branch**: `003-product-scenario-types`  
**Created**: 2026-01-31  
**Status**: Draft  
**Input**: User description: "产品/场景/类型管理模块 - 业务领域核心概念模型，支撑会计流程设计和AI分析"

## Overview

本模块定义业务领域的核心概念模型：Product（产品）、Scenario（场景）、TransactionType（交易类型）。这些模型构成了会计流程设计的业务基础，承载业务背景描述、资金流信息流定义，是 AI 分析的重要输入和上下文来源。

### 层级关系

```
Product（产品）
  └── Scenario（场景）
        └── TransactionType（交易类型）
              └── BookingRule（记账规则）[已有模块]
```

### 与其他模块的关系

- **记账规则模块**：规则按产品/场景/类型组织，支持规则的复用和继承
- **AI 分析会话模块**（下一期）：根据产品/场景信息理解业务背景，生成科目和规则建议

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 创建和管理产品 (Priority: P1)

作为会计系统设计师，我需要创建和管理产品定义，以便描述业务产品线的核心信息，包括业务模式、参与方、资金流向等。

**Why this priority**: 产品是层级结构的根节点，必须先有产品才能创建场景和交易类型。

**Independent Test**: 可以独立创建、查看、更新产品，并验证产品信息正确保存和展示。

**Acceptance Scenarios**:

1. **Given** 系统中无产品, **When** 用户创建产品"消费贷款"并填写业务描述, **Then** 产品创建成功并可在列表中查看
2. **Given** 已存在产品"消费贷款", **When** 用户更新产品的业务描述, **Then** 更新成功并保留版本历史
3. **Given** 已存在产品"消费贷款", **When** 用户查看产品详情, **Then** 显示产品的完整信息包括关联的场景数量
4. **Given** 产品下无关联场景, **When** 用户删除产品, **Then** 产品删除成功
5. **Given** 产品下存在关联场景, **When** 用户尝试删除产品, **Then** 系统拒绝删除并提示存在关联数据

---

### User Story 2 - 创建和管理场景 (Priority: P1)

作为会计系统设计师，我需要在产品下创建和管理业务场景，以便定义具体的业务触发条件和资金流转路径。

**Why this priority**: 场景是连接产品和交易类型的关键层级，定义了业务的核心流程。

**Independent Test**: 可以在已有产品下独立创建、查看、更新场景，验证场景与产品的关联关系。

**Acceptance Scenarios**:

1. **Given** 已存在产品"消费贷款", **When** 用户在该产品下创建场景"放款", **Then** 场景创建成功并关联到该产品
2. **Given** 已存在场景"放款", **When** 用户更新场景的触发条件描述, **Then** 更新成功
3. **Given** 已存在多个场景, **When** 用户按产品筛选场景列表, **Then** 只显示该产品下的场景
4. **Given** 场景下无关联交易类型, **When** 用户删除场景, **Then** 场景删除成功
5. **Given** 场景下存在关联交易类型, **When** 用户尝试删除场景, **Then** 系统拒绝删除并提示存在关联数据

---

### User Story 3 - 创建和管理交易类型 (Priority: P1)

作为会计系统设计师，我需要在场景下创建和管理交易类型，以便细分业务处理并关联具体的记账规则。

**Why this priority**: 交易类型是与记账规则直接关联的实体，是业务到账务的桥梁。

**Independent Test**: 可以在已有场景下独立创建、查看、更新交易类型，验证与场景的关联关系。

**Acceptance Scenarios**:

1. **Given** 已存在场景"放款", **When** 用户创建交易类型"正常放款", **Then** 交易类型创建成功并关联到该场景
2. **Given** 已存在交易类型, **When** 用户关联已有的记账规则到该交易类型, **Then** 关联成功
3. **Given** 已存在交易类型, **When** 用户查看交易类型详情, **Then** 显示关联的记账规则列表
4. **Given** 交易类型未关联记账规则, **When** 用户删除交易类型, **Then** 删除成功
5. **Given** 交易类型已关联记账规则, **When** 用户尝试删除交易类型, **Then** 系统提示确认是否解除规则关联后删除

---

### User Story 4 - 层级导航和关联查询 (Priority: P2)

作为会计系统设计师，我需要按层级浏览和查询产品/场景/类型及其关联的科目和规则，以便全面了解业务结构。

**Why this priority**: 层级导航是理解业务全貌的重要功能，但不影响基础CRUD操作。

**Independent Test**: 可以从产品级别向下钻取查看完整的层级结构和关联资源。

**Acceptance Scenarios**:

1. **Given** 存在完整的产品→场景→类型层级, **When** 用户查看产品的层级树, **Then** 显示该产品下所有场景和类型的树状结构
2. **Given** 某类型关联了记账规则, **When** 用户查看该类型的关联规则, **Then** 显示所有关联的记账规则及其状态
3. **Given** 某场景下有多个类型, **When** 用户查看该场景涉及的所有科目, **Then** 汇总显示所有类型关联规则中使用的科目

---

### User Story 5 - 模板复用 (Priority: P3)

作为会计系统设计师，我需要从已有产品/场景复制创建新的产品/场景，以便快速复用已有的业务设计。

**Why this priority**: 模板复用是效率提升功能，在基础功能完成后实现。

**Independent Test**: 可以复制已有产品/场景创建新实例，验证复制的完整性。

**Acceptance Scenarios**:

1. **Given** 已存在完整配置的产品, **When** 用户复制该产品, **Then** 创建新产品并复制其下所有场景和类型（但不复制规则关联）
2. **Given** 已存在场景, **When** 用户复制该场景到同一产品, **Then** 创建新场景并复制其下所有类型
3. **Given** 已存在场景, **When** 用户复制该场景到不同产品, **Then** 创建新场景并正确关联到目标产品

---

### Edge Cases

- 产品/场景/类型的code必须在同级别内唯一
- 删除操作需要检查下级关联，防止级联删除导致数据丢失
- 层级深度限制：Product → Scenario → TransactionType 固定三层，不支持更深嵌套
- 复制操作时如遇code冲突，自动添加后缀（如 `-copy-1`）
- 大量数据时的分页和搜索性能

## Requirements *(mandatory)*

### Functional Requirements

#### 产品管理

- **FR-001**: 系统必须支持创建产品，包含以下属性：代码(code)、名称(name)、业务描述(description)、业务模式描述(businessModel)、参与方描述(participants)、资金流向描述(fundFlow)
- **FR-002**: 系统必须支持更新产品信息，并记录版本历史
- **FR-003**: 系统必须支持查询产品列表，支持分页和按名称/代码搜索
- **FR-004**: 系统必须支持查看产品详情，包含关联场景的统计信息
- **FR-005**: 系统必须在产品无下级场景时允许删除，有下级时拒绝并提示

#### 场景管理

- **FR-006**: 系统必须支持在指定产品下创建场景，包含：代码(code)、名称(name)、业务描述(description)、触发条件描述(triggerDescription)、资金流转路径描述(fundFlowPath)
- **FR-007**: 系统必须支持更新场景信息
- **FR-008**: 系统必须支持按产品筛选查询场景列表
- **FR-009**: 系统必须支持查看场景详情，包含关联交易类型的统计信息
- **FR-010**: 系统必须在场景无下级类型时允许删除，有下级时拒绝并提示

#### 交易类型管理

- **FR-011**: 系统必须支持在指定场景下创建交易类型，包含：代码(code)、名称(name)、业务描述(description)
- **FR-012**: 系统必须支持将已有记账规则关联到交易类型
- **FR-013**: 系统必须支持解除交易类型与记账规则的关联
- **FR-014**: 系统必须支持查看交易类型详情，包含关联的记账规则列表
- **FR-015**: 系统必须在删除交易类型时，解除与规则的关联关系（不删除规则本身）

#### 层级导航与查询

- **FR-016**: 系统必须支持获取指定产品的完整层级树（包含场景和类型）
- **FR-017**: 系统必须支持查询指定层级（产品/场景/类型）关联的所有记账规则
- **FR-018**: 系统必须支持查询指定层级涉及的所有科目（从关联规则中提取）

#### 模板复用

- **FR-019**: 系统必须支持复制产品，包含其下所有场景和类型结构（不复制规则关联）
- **FR-020**: 系统必须支持复制场景到同一或不同产品下
- **FR-021**: 复制时如遇code冲突，系统必须自动生成新的唯一code

#### 数据完整性

- **FR-022**: 产品/场景/类型的code在同级别内必须唯一
- **FR-023**: 系统必须支持乐观锁机制防止并发更新冲突

### Key Entities

- **Product（产品）**: 业务产品线定义，顶层实体。包含业务模式、参与方、资金流向等丰富的业务描述信息。
- **Scenario（场景）**: 产品下的业务场景，描述具体的触发条件和资金流转路径。属于某个Product。
- **TransactionType（交易类型）**: 场景下的交易细分类型，与记账规则直接关联。属于某个Scenario。
- **TransactionTypeRule（类型规则关联）**: 交易类型与记账规则的多对多关联关系。

### 实体关系

```
Product (1) ──────< Scenario (N)
Scenario (1) ─────< TransactionType (N)
TransactionType (N) ─────── TransactionTypeRule ───────< AccountingRule (N)
```

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户可在 30 秒内完成产品/场景/类型的创建操作
- **SC-002**: 层级树查询响应时间在 500ms 以内（1000条记录规模）
- **SC-003**: 关联规则查询准确率 100%，无遗漏或错误关联
- **SC-004**: 复制操作保持数据完整性，结构一致性达到 100%
- **SC-005**: 删除保护机制 100% 生效，不会意外删除有下级数据的实体
- **SC-006**: 所有业务描述字段支持中英文及特殊字符，无乱码或截断

## Assumptions

1. 记账规则模块（AccountingRule）已实现并可用于关联
2. 层级结构固定为三层：Product → Scenario → TransactionType
3. 一个记账规则可以被多个交易类型关联（多对多关系）
4. 产品/场景/类型的业务描述主要用于AI分析和人工理解，不参与业务逻辑判断
5. 版本历史功能在本期简化实现，仅记录更新时间和更新人

## Out of Scope

- AI 分析会话功能（下一期工作）
- 记账规则的继承机制
- 跨产品的场景共享
- 审批工作流
- 多租户隔离
