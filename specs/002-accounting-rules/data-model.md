# Data Model: Accounting Rules Management

**Feature**: 002-accounting-rules  
**Date**: 2026-01-31  
**Status**: Complete

---

## Entity Relationship Diagram

```
┌─────────────────────┐       ┌─────────────────────┐
│   AccountingRule    │       │  AccountingRuleVersion │
├─────────────────────┤       ├─────────────────────┤
│ id (PK)             │◄──────│ id (PK)             │
│ code (UNIQUE)       │   1:N │ rule_id (FK)        │
│ name                │       │ version_number      │
│ description         │       │ snapshot_json       │
│ status              │       │ change_description  │
│ shared_across       │       │ created_at          │
│ current_version     │       │ created_by          │
│ version (optimistic)│       └─────────────────────┘
│ created_at          │
│ updated_at          │
└─────────────────────┘
         │
         │ 1:1
         ▼
┌─────────────────────┐
│    EntryTemplate    │
├─────────────────────┤
│ id (PK)             │
│ rule_id (FK, UNIQUE)│
│ description         │
│ variable_schema_json│
│ created_at          │
│ updated_at          │
└─────────────────────┘
         │
         │ 1:N
         ▼
┌─────────────────────┐       ┌─────────────────────┐
│     EntryLine       │       │  TriggerCondition   │
├─────────────────────┤       ├─────────────────────┤
│ id (PK)             │       │ id (PK)             │
│ template_id (FK)    │       │ rule_id (FK)        │
│ sequence_number     │       │ condition_json      │
│ account_code        │───────│ description         │
│ entry_type          │   N:1 │ created_at          │
│ amount_expression   │   to  │ updated_at          │
│ memo_template       │  COA  └─────────────────────┘
│ created_at          │
│ updated_at          │
└─────────────────────┘
         │
         │ N:1 (references)
         ▼
┌─────────────────────┐
│  Account (COA)      │
│  (from 001-coa)     │
└─────────────────────┘
```

---

## Entities

### 1. AccountingRule

The primary entity representing an accounting rule definition.

| Attribute | Type | Constraints | Description |
|-----------|------|-------------|-------------|
| id | BIGINT | PK, AUTO_INCREMENT | Unique identifier |
| code | VARCHAR(50) | UNIQUE, NOT NULL | Business code (e.g., "RULE-001") |
| name | VARCHAR(255) | NOT NULL | Human-readable name |
| description | TEXT | NULLABLE | Detailed description |
| status | ENUM | NOT NULL, DEFAULT 'DRAFT' | Current lifecycle state |
| shared_across_scenarios | BOOLEAN | NOT NULL, DEFAULT FALSE | Can be reused in multiple scenarios |
| current_version | INTEGER | NOT NULL, DEFAULT 1 | Current version number |
| version | BIGINT | NOT NULL, DEFAULT 0 | Optimistic lock version |
| created_at | TIMESTAMP | NOT NULL | Creation timestamp |
| updated_at | TIMESTAMP | NOT NULL | Last modification timestamp |
| created_by | VARCHAR(100) | NULLABLE | Creator identifier |
| updated_by | VARCHAR(100) | NULLABLE | Last modifier identifier |

**Status Enum Values**: `DRAFT`, `ACTIVE`, `ARCHIVED`

**State Transitions**:
- DRAFT → ACTIVE: Requires all validations pass
- ACTIVE → ARCHIVED: Always allowed
- ARCHIVED → DRAFT: Always allowed (creates new version)
- DRAFT → ARCHIVED: Always allowed

**Indexes**:
- `idx_rules_code` on `code`
- `idx_rules_status` on `status`
- `idx_rules_shared` on `shared_across_scenarios`

---

### 2. AccountingRuleVersion

Stores complete snapshots of rule state for version history.

| Attribute | Type | Constraints | Description |
|-----------|------|-------------|-------------|
| id | BIGINT | PK, AUTO_INCREMENT | Unique identifier |
| rule_id | BIGINT | FK → AccountingRule.id, NOT NULL | Parent rule |
| version_number | INTEGER | NOT NULL | Version sequence (1, 2, 3...) |
| snapshot_json | TEXT | NOT NULL | Complete rule state as JSON |
| change_description | VARCHAR(500) | NULLABLE | Description of changes |
| created_at | TIMESTAMP | NOT NULL | Version creation timestamp |
| created_by | VARCHAR(100) | NULLABLE | Version creator |

**Unique Constraint**: `(rule_id, version_number)`

**Indexes**:
- `idx_versions_rule_id` on `rule_id`
- `idx_versions_created_at` on `created_at`

**Snapshot JSON Structure**:
```json
{
  "code": "RULE-001",
  "name": "Payment Received Rule",
  "description": "...",
  "status": "ACTIVE",
  "entryTemplate": {
    "description": "...",
    "variableSchema": [...],
    "lines": [...]
  },
  "triggerConditions": [...]
}
```

---

### 3. EntryTemplate

Defines the journal entry structure to be generated by a rule.

| Attribute | Type | Constraints | Description |
|-----------|------|-------------|-------------|
| id | BIGINT | PK, AUTO_INCREMENT | Unique identifier |
| rule_id | BIGINT | FK → AccountingRule.id, UNIQUE | Associated rule (1:1) |
| description | TEXT | NULLABLE | Template description |
| variable_schema_json | TEXT | NOT NULL | JSON array of variable definitions |
| created_at | TIMESTAMP | NOT NULL | Creation timestamp |
| updated_at | TIMESTAMP | NOT NULL | Last modification timestamp |

**Variable Schema JSON Structure**:
```json
[
  {
    "name": "transaction.amount",
    "type": "MONEY",
    "currency": "USD",
    "description": "Transaction amount"
  },
  {
    "name": "transaction.fee_rate",
    "type": "DECIMAL",
    "description": "Fee percentage as decimal"
  }
]
```

**Supported Types**: `DECIMAL`, `MONEY`, `BOOLEAN`, `STRING`

---

### 4. EntryLine

A single debit or credit line within an entry template.

| Attribute | Type | Constraints | Description |
|-----------|------|-------------|-------------|
| id | BIGINT | PK, AUTO_INCREMENT | Unique identifier |
| template_id | BIGINT | FK → EntryTemplate.id, NOT NULL | Parent template |
| sequence_number | INTEGER | NOT NULL | Display/processing order |
| account_code | VARCHAR(50) | NOT NULL | Reference to COA account |
| entry_type | ENUM | NOT NULL | DEBIT or CREDIT |
| amount_expression | VARCHAR(500) | NOT NULL | Expression for calculating amount |
| memo_template | VARCHAR(255) | NULLABLE | Template for entry memo |
| created_at | TIMESTAMP | NOT NULL | Creation timestamp |
| updated_at | TIMESTAMP | NOT NULL | Last modification timestamp |

**Entry Type Enum**: `DEBIT`, `CREDIT`

**Unique Constraint**: `(template_id, sequence_number)`

**Indexes**:
- `idx_entry_lines_template_id` on `template_id`
- `idx_entry_lines_account_code` on `account_code`

**Amount Expression Examples**:
- Simple: `transaction.amount`
- Calculated: `transaction.amount * 0.1`
- Complex: `(transaction.amount - transaction.discount) * transaction.tax_rate`

---

### 5. TriggerCondition

Defines conditions for when a rule should be applied.

| Attribute | Type | Constraints | Description |
|-----------|------|-------------|-------------|
| id | BIGINT | PK, AUTO_INCREMENT | Unique identifier |
| rule_id | BIGINT | FK → AccountingRule.id, NOT NULL | Associated rule |
| condition_json | TEXT | NOT NULL | JSON structure defining the condition |
| description | VARCHAR(255) | NULLABLE | Human-readable description |
| created_at | TIMESTAMP | NOT NULL | Creation timestamp |
| updated_at | TIMESTAMP | NOT NULL | Last modification timestamp |

**Condition JSON Structure**:
```json
{
  "type": "AND",
  "conditions": [
    {
      "type": "SIMPLE",
      "field": "event.type",
      "operator": "EQUALS",
      "value": "payment_received"
    },
    {
      "type": "OR",
      "conditions": [
        {
          "type": "SIMPLE",
          "field": "event.amount",
          "operator": "GREATER_THAN",
          "value": 10000
        },
        {
          "type": "SIMPLE",
          "field": "event.priority",
          "operator": "EQUALS",
          "value": "high"
        }
      ]
    }
  ]
}
```

**Supported Operators**:
| Operator | Description | Applicable Types |
|----------|-------------|------------------|
| EQUALS | Exact match | All |
| NOT_EQUALS | Not equal | All |
| GREATER_THAN | Greater than | Numeric |
| GREATER_THAN_OR_EQUALS | >= | Numeric |
| LESS_THAN | Less than | Numeric |
| LESS_THAN_OR_EQUALS | <= | Numeric |
| CONTAINS | Substring match | String |
| MATCHES | Regex match | String |
| IN | Value in list | All |
| NOT_IN | Value not in list | All |

---

## Validation Rules

### AccountingRule
- `code` must match pattern `^[A-Z0-9-]+$`
- `code` must be unique across all rules
- `name` length: 1-255 characters
- Cannot delete if `status == ACTIVE` and referenced by scenarios

### EntryTemplate
- Must have at least one EntryLine
- All variables used in expressions must be defined in `variable_schema_json`
- Variable names must match pattern `^[a-z][a-z0-9_.]*$`

### EntryLine
- `account_code` must reference existing account in COA
- `amount_expression` must be syntactically valid
- `amount_expression` must only use variables defined in template schema
- `sequence_number` must be unique within template

### TriggerCondition
- `condition_json` must be valid JSON matching expected structure
- Field names must be valid identifiers
- Values must be compatible with specified operators

---

## State Transitions

### AccountingRule Lifecycle

```
┌──────────────────────────────────────────────────────────────┐
│                                                              │
│  ┌────────┐                                                  │
│  │ CREATE │                                                  │
│  └───┬────┘                                                  │
│      │                                                       │
│      ▼                                                       │
│  ┌────────┐   activate()   ┌────────┐   archive()   ┌──────────┐
│  │ DRAFT  │───────────────►│ ACTIVE │──────────────►│ ARCHIVED │
│  └────────┘   [validates]  └────────┘               └──────────┘
│      │                          │                        │
│      │ archive()                │                        │
│      │ [no validation]          │                        │
│      ▼                          │                        │
│  ┌──────────┐                   │                        │
│  │ ARCHIVED │◄──────────────────┘                        │
│  └──────────┘                                            │
│      │                                                   │
│      │ restore()                                         │
│      │ [creates new version]                             │
│      ▼                                                   │
│  ┌────────┐                                              │
│  │ DRAFT  │◄─────────────────────────────────────────────┘
│  └────────┘   restore() [creates new version]
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### Activation Validation Checks

Before transitioning DRAFT → ACTIVE:

1. **Syntax Validation**
   - All amount expressions parse successfully
   - All condition JSON is structurally valid

2. **Reference Validation**
   - All `account_code` values exist in COA
   - All accounts have Formance mappings (for Numscript generation)

3. **Completeness Validation**
   - At least one entry line exists
   - All variables in expressions are defined in schema

4. **Balance Warning** (non-blocking)
   - Sum of debit expressions may not equal sum of credit expressions
   - Warning issued but activation allowed

---

## Database Schema (PostgreSQL)

```sql
-- Accounting Rules
CREATE TABLE accounting_rules (
    id BIGSERIAL PRIMARY KEY,
    code VARCHAR(50) NOT NULL UNIQUE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    status VARCHAR(20) NOT NULL DEFAULT 'DRAFT',
    shared_across_scenarios BOOLEAN NOT NULL DEFAULT FALSE,
    current_version INTEGER NOT NULL DEFAULT 1,
    version BIGINT NOT NULL DEFAULT 0,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(100),
    updated_by VARCHAR(100),
    
    CONSTRAINT chk_status CHECK (status IN ('DRAFT', 'ACTIVE', 'ARCHIVED'))
);

CREATE INDEX idx_rules_code ON accounting_rules(code);
CREATE INDEX idx_rules_status ON accounting_rules(status);
CREATE INDEX idx_rules_shared ON accounting_rules(shared_across_scenarios);

-- Rule Versions
CREATE TABLE accounting_rule_versions (
    id BIGSERIAL PRIMARY KEY,
    rule_id BIGINT NOT NULL REFERENCES accounting_rules(id) ON DELETE CASCADE,
    version_number INTEGER NOT NULL,
    snapshot_json TEXT NOT NULL,
    change_description VARCHAR(500),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(100),
    
    CONSTRAINT uk_rule_version UNIQUE (rule_id, version_number)
);

CREATE INDEX idx_versions_rule_id ON accounting_rule_versions(rule_id);
CREATE INDEX idx_versions_created_at ON accounting_rule_versions(created_at);

-- Entry Templates
CREATE TABLE entry_templates (
    id BIGSERIAL PRIMARY KEY,
    rule_id BIGINT NOT NULL UNIQUE REFERENCES accounting_rules(id) ON DELETE CASCADE,
    description TEXT,
    variable_schema_json TEXT NOT NULL DEFAULT '[]',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Entry Lines
CREATE TABLE entry_lines (
    id BIGSERIAL PRIMARY KEY,
    template_id BIGINT NOT NULL REFERENCES entry_templates(id) ON DELETE CASCADE,
    sequence_number INTEGER NOT NULL,
    account_code VARCHAR(50) NOT NULL,
    entry_type VARCHAR(10) NOT NULL,
    amount_expression VARCHAR(500) NOT NULL,
    memo_template VARCHAR(255),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT chk_entry_type CHECK (entry_type IN ('DEBIT', 'CREDIT')),
    CONSTRAINT uk_line_sequence UNIQUE (template_id, sequence_number)
);

CREATE INDEX idx_entry_lines_template_id ON entry_lines(template_id);
CREATE INDEX idx_entry_lines_account_code ON entry_lines(account_code);

-- Trigger Conditions
CREATE TABLE trigger_conditions (
    id BIGSERIAL PRIMARY KEY,
    rule_id BIGINT NOT NULL REFERENCES accounting_rules(id) ON DELETE CASCADE,
    condition_json TEXT NOT NULL,
    description VARCHAR(255),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_trigger_conditions_rule_id ON trigger_conditions(rule_id);

-- Updated timestamp trigger
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_accounting_rules_updated_at
    BEFORE UPDATE ON accounting_rules
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_entry_templates_updated_at
    BEFORE UPDATE ON entry_templates
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_entry_lines_updated_at
    BEFORE UPDATE ON entry_lines
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_trigger_conditions_updated_at
    BEFORE UPDATE ON trigger_conditions
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

---

## Integration with COA Module

### Account Reference Tracking

When an `EntryLine` references an account, the rules module should create an `AccountReference` in the COA module:

```java
AccountReference reference = AccountReference.builder()
    .accountCode(entryLine.getAccountCode())
    .referenceType(ReferenceType.RULE)
    .referenceSourceId(String.valueOf(rule.getId()))
    .build();
accountReferenceRepository.save(reference);
```

This enables:
- Prevention of account deletion when referenced by rules
- Impact analysis showing which rules use an account

### Account Validation

Before rule activation:
```java
for (EntryLine line : template.getLines()) {
    if (!accountService.existsByCode(line.getAccountCode())) {
        throw new RuleValidationException(
            "Account not found: " + line.getAccountCode());
    }
    if (!accountMappingService.hasMapping(line.getAccountCode())) {
        throw new RuleValidationException(
            "Account has no Formance mapping: " + line.getAccountCode());
    }
}
```
