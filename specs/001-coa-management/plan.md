# Implementation Plan: Chart of Accounts Management

**Branch**: `001-coa-management` | **Date**: 2026-01-28 | **Spec**: [spec.md](./spec.md)  
**Input**: Feature specification from `/specs/001-coa-management/spec.md`

## Summary

Implement a foundational Chart of Accounts (COA) management module that provides RESTful API services for creating, maintaining, and importing hierarchical account structures. This module serves as the data core for the AI-assisted accounting rule design platform, enabling account CRUD operations, Formance Ledger mappings, Excel/CSV batch imports, and cross-scenario reusability validation. The system enforces immutability constraints on referenced accounts and maintains parent-child relationships in a tree structure.

## Technical Context

**Language/Version**: Java 21 (per constitution: Spring Boot/Cloud)  
**Primary Dependencies**: Spring Boot 3.x, Spring Data JPA, Spring Web, Apache POI (Excel), OpenCSV, SpringDoc OpenAPI  
**Storage**: PostgreSQL (relational DB for hierarchical data with recursive queries)  
**Testing**: JUnit 5, Spring Boot Test, Testcontainers (for DB integration tests)  
**Target Platform**: Linux server (Docker containerized)  
**Project Type**: Single backend API (no frontend in this module)  
**Performance Goals**: <200ms p95 for CRUD operations, <10s for 500-account imports, support 10k+ accounts  
**Constraints**: <500ms for tree retrieval (1000 accounts), zero data loss in concurrent operations, API-only (no UI)  
**Scale/Scope**: RESTful API with 15+ endpoints, support for hierarchical queries, file parsing, validation logic

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Pre-Research Evaluation

| Principle | Compliance Status | Notes |
|-----------|------------------|-------|
| **I. Domain Design Assistant** | ✅ PASS | Module produces design artifacts (COA structures, mappings), does not execute transactions |
| **II. Hierarchical Consistency** | ✅ PASS | COA is foundational layer for Product → Scenario → Type hierarchy, enforces reusability |
| **III. AI-Human Collaboration** | ✅ PASS | Supports Excel/CSV import for existing structures, provides validation APIs for AI suggestions |
| **IV. Numscript DSL Output** | ✅ N/A | This module manages accounts; Numscript generation handled by separate rule design module |
| **V. OpenAPI-First Backend** | ✅ PASS | All APIs will be OpenAPI 3.0 compliant with SpringDoc |
| **VI. Containerized Deployment** | ✅ PASS | Will provide Dockerfile and docker-compose integration |

**Pre-Research Result**: ✅ **PASS** - No violations, proceed to Phase 0

### Post-Design Evaluation

*To be completed after Phase 1*

## Project Structure

### Documentation (this feature)

```text
specs/001-coa-management/
├── spec.md              # Feature specification
├── plan.md              # This file (implementation plan)
├── research.md          # Phase 0 output (technical decisions)
├── data-model.md        # Phase 1 output (entities and relationships)
├── quickstart.md        # Phase 1 output (setup and usage guide)
├── contracts/           # Phase 1 output (OpenAPI specifications)
│   └── coa-api.yaml
├── checklists/          # Quality validation
│   └── requirements.md
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
backend/
├── src/main/java/com/financial/coa/
│   ├── controller/          # REST controllers
│   │   ├── AccountController.java
│   │   ├── AccountMappingController.java
│   │   └── AccountImportController.java
│   ├── service/             # Business logic
│   │   ├── AccountService.java
│   │   ├── AccountMappingService.java
│   │   ├── AccountImportService.java
│   │   ├── AccountValidationService.java
│   │   └── FileParserService.java
│   ├── repository/          # Data access
│   │   ├── AccountRepository.java
│   │   ├── AccountMappingRepository.java
│   │   └── AccountReferenceRepository.java
│   ├── domain/              # Domain entities
│   │   ├── Account.java
│   │   ├── AccountMapping.java
│   │   ├── AccountReference.java
│   │   └── ImportJob.java
│   ├── dto/                 # Data transfer objects
│   │   ├── AccountDto.java
│   │   ├── AccountTreeDto.java
│   │   ├── MappingDto.java
│   │   └── ImportRequestDto.java
│   ├── exception/           # Custom exceptions
│   │   ├── DuplicateAccountCodeException.java
│   │   ├── AccountReferencedException.java
│   │   └── InvalidImportFileException.java
│   └── config/              # Configuration
│       ├── OpenApiConfig.java
│       └── DataSourceConfig.java
├── src/main/resources/
│   ├── application.yml
│   ├── db/migration/        # Flyway migrations
│   │   └── V1__create_coa_tables.sql
│   └── openapi/
│       └── coa-api.yaml     # Symlink to specs/001-coa-management/contracts/
├── src/test/java/com/financial/coa/
│   ├── controller/          # Controller tests
│   ├── service/             # Service tests
│   ├── repository/          # Repository tests
│   └── integration/         # Integration tests
│       ├── AccountIntegrationTest.java
│       ├── ImportIntegrationTest.java
│       └── ConcurrencyTest.java
└── Dockerfile

docker-compose.yml           # Update to include COA service
api-specs/coa-api.yaml      # Shared API spec location
```

**Structure Decision**: Single backend API project following Spring Boot conventions. Chose monolithic structure for this foundational module to minimize deployment complexity. Future modules can be added as separate services or packages within the same Spring Boot application, decision deferred until second module design.

## Complexity Tracking

> No constitution violations - this section intentionally left empty
