# Implementation Plan: Transaction Flow Viewer

**Branch**: `005-transaction-flow-viewer` | **Date**: 2026-01-31 | **Spec**: [spec.md](./spec.md)  
**Input**: Feature specification from `/specs/005-transaction-flow-viewer/spec.md`

## Summary

This feature provides frontend pages and backend APIs for browsing and visualizing transaction flow designs created through AI analysis sessions. Key capabilities include:
- Hierarchical navigation (Product → Scenario → Transaction Type)
- Transaction detail view with accounts, journal entries, and Numscript DSL
- Interactive flow diagrams showing cash flow and information flow
- Real-time design preview panel during AI sessions

This is a **read-only** feature that aggregates data from existing 004-ai-analysis-session entities.

## Technical Context

**Language/Version**: Java 21 (backend), TypeScript (frontend)  
**Primary Dependencies**: Spring Boot, Vue 3 + Nuxt, Vue Flow, Prism.js  
**Storage**: PostgreSQL (reads from existing tables, no new tables)  
**Testing**: JUnit 5 (backend), Vitest (frontend)  
**Target Platform**: Web application (Docker containerized)  
**Project Type**: Web application (frontend + backend)  
**Performance Goals**: <2s diagram render, <500ms preview updates  
**Constraints**: Read-only, no new persistent entities  
**Scale/Scope**: Support up to 1000 transaction flows, 20 accounts per flow

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Pre-Design | Post-Design | Notes |
|-----------|------------|-------------|-------|
| I. Domain Design Assistant | ✅ | ✅ | Read-only viewing, no transaction processing |
| II. Hierarchical Consistency | ✅ | ✅ | Displays Product → Scenario → Type hierarchy |
| III. AI-Human Collaboration | ✅ | ✅ | Shows AI proposals vs confirmed decisions in preview |
| IV. Numscript DSL Output | ✅ | ✅ | Displays and validates Numscript with syntax highlighting |
| V. OpenAPI-First Backend | ✅ | ✅ | API contract defined in `contracts/transaction-flow-api.yaml` |
| VI. Containerized Deployment | ✅ | ✅ | No new services, uses existing Docker setup |

**All gates passed. No violations.**

## Project Structure

### Documentation (this feature)

```text
specs/005-transaction-flow-viewer/
├── plan.md              # This file
├── research.md          # Technology decisions (Vue Flow, Prism.js, etc.)
├── data-model.md        # View model definitions (DTOs only, no new tables)
├── quickstart.md        # Setup and implementation guide
├── contracts/
│   └── transaction-flow-api.yaml  # OpenAPI specification
├── checklists/
│   └── requirements.md  # Specification quality checklist
└── tasks.md             # (To be generated by /speckit.tasks)
```

### Source Code (repository root)

```text
backend/
├── src/main/java/com/financial/
│   ├── transactionflow/           # NEW: This feature
│   │   ├── controller/
│   │   │   ├── TransactionFlowController.java
│   │   │   └── PreviewController.java
│   │   ├── service/
│   │   │   ├── TransactionFlowService.java
│   │   │   ├── FlowDiagramService.java
│   │   │   └── PreviewService.java
│   │   └── dto/
│   │       ├── ProductSummary.java
│   │       ├── ScenarioSummary.java
│   │       ├── TransactionFlowView.java
│   │       ├── AccountNodeDto.java
│   │       ├── JournalEntryDisplayDto.java
│   │       ├── FlowConnectionDto.java
│   │       ├── NumscriptViewDto.java
│   │       └── DesignPreviewDto.java
│   └── ai/                        # Existing 004 feature
│       ├── domain/
│       │   ├── DesignDecision.java    # Read from
│       │   └── ExportArtifact.java    # Read from
│       └── repository/
└── src/test/java/com/financial/transactionflow/

frontend/
├── pages/
│   ├── flows/
│   │   ├── index.vue              # NEW: Transaction Flow Browser
│   │   └── [code].vue             # NEW: Transaction Flow Detail
│   └── analysis/
│       └── [id].vue               # MODIFIED: Add preview panel
├── components/
│   ├── flows/                     # NEW: Flow-related components
│   │   ├── ProductScenarioTree.vue
│   │   ├── TransactionFlowList.vue
│   │   ├── AccountsTable.vue
│   │   ├── JournalEntriesTable.vue
│   │   ├── FlowDiagram.vue
│   │   ├── AccountNode.vue
│   │   ├── NumscriptViewer.vue
│   │   └── TransactionTimeline.vue
│   └── preview/                   # NEW: Preview panel components
│       ├── DesignPreviewPanel.vue
│       ├── AccountsList.vue
│       ├── EntriesSummary.vue
│       └── MiniFlowDiagram.vue
├── composables/
│   ├── useTransactionFlows.ts     # NEW: API composable
│   └── useDesignPreview.ts        # NEW: SSE preview composable
├── plugins/
│   └── prism-numscript.ts         # NEW: Numscript syntax definition
└── tests/
```

**Structure Decision**: Web application structure following existing patterns. New `transactionflow` package in backend, new `flows` and `preview` directories in frontend.

## Technology Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Flow diagram library | Vue Flow | Native Vue 3, built-in zoom/pan, dagre layout support |
| Numscript highlighting | Prism.js + custom grammar | Lightweight, easy to extend for custom DSL |
| Real-time preview | SSE (Server-Sent Events) | Already used in 004, simpler than WebSocket for one-way updates |
| Graph layout | dagre.js | Standard library for directed graph layout |
| Data source | Read from DesignDecision | No data duplication, single source of truth |

## Dependencies to Add

### Frontend (package.json)

```json
{
  "@vue-flow/core": "^1.x",
  "@vue-flow/background": "^1.x",
  "dagre": "^0.8.x",
  "prismjs": "^1.29.x"
}
```

### Backend

No new dependencies required. Uses existing Spring WebFlux for SSE.

## API Endpoints Summary

| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/v1/transaction-flows/products` | List products with counts |
| GET | `/api/v1/transaction-flows/products/{code}` | Product detail with scenarios |
| GET | `/api/v1/transaction-flows/products/{code}/scenarios` | List scenarios |
| GET | `/api/v1/transaction-flows/scenarios/{code}` | Scenario detail |
| GET | `/api/v1/transaction-flows` | List all transaction flows (flat) |
| GET | `/api/v1/transaction-flows/{code}` | Full transaction flow view |
| GET | `/api/v1/transaction-flows/{code}/numscript` | Numscript with validation |
| GET | `/api/v1/transaction-flows/{code}/diagram` | Flow diagram data |
| GET | `/api/v1/transaction-flows/{code}/timeline` | Timeline data |
| GET | `/api/v1/sessions/{id}/preview` | Current preview state |
| GET | `/api/v1/sessions/{id}/preview/stream` | SSE preview updates |

## Integration Points

1. **DesignDecision (004)**: Source for confirmed accounts, entries, transaction structures
2. **ExportArtifact (004)**: Source for finalized Numscript code
3. **Account (001)**: Verify COA linkage for accounts
4. **AI Session page**: Embed preview panel component

## Complexity Tracking

> No violations requiring justification.

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| (none) | - | - |

## Phase Outputs

- ✅ `research.md` - Technology decisions documented
- ✅ `data-model.md` - View model definitions (DTOs)
- ✅ `contracts/transaction-flow-api.yaml` - OpenAPI specification
- ✅ `quickstart.md` - Implementation guide
- ⏳ `tasks.md` - To be generated by `/speckit.tasks`

## Next Steps

Run `/speckit.tasks` to generate implementation tasks from this plan.
